From a24d48c64e8c19cd4a7252272c08d5520e8862bf Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Tue, 19 Mar 2024 05:11:11 +0100
Subject: [PATCH 25/29] winegstreamer: Adjust buffer timestamps after seek.

---
 dlls/winegstreamer/wg_parser.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index 9996f6848cd..56ae2c3c026 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -80,6 +80,8 @@ struct wg_parser
     guint64 next_pull_offset;
     gchar *uri;
 
+    guint64 seek_pos;
+
     pthread_t push_thread;
 
     pthread_mutex_t mutex;
@@ -404,7 +406,7 @@ retry:
                 release_buffer(parser, stream);
                 goto retry;
             }
-            wg_buffer->pts = stream_time / 100;
+            wg_buffer->pts = (stream_time + parser->seek_pos) / 100;
         }
     }
     if ((wg_buffer->has_duration = GST_BUFFER_DURATION_IS_VALID(buffer)))
@@ -505,6 +507,8 @@ static NTSTATUS wg_parser_stream_seek(void *args)
     if ((stop_flags & AM_SEEKING_PositioningBitsMask) == AM_SEEKING_NoPositioning)
         stop_type = GST_SEEK_TYPE_NONE;
 
+    stream->parser->seek_pos = params->start_pos * 100;
+
     if (!push_event(stream->my_sink, gst_event_new_seek(params->rate, GST_FORMAT_TIME,
             flags, start_type, params->start_pos * 100, stop_type,
             params->stop_pos == stream->duration ? -1 : params->stop_pos * 100)))
@@ -2088,6 +2092,8 @@ static NTSTATUS wg_parser_connect(void *args)
     parser->next_pull_offset = 0;
     parser->error = false;
 
+    parser->seek_pos = 0;
+
     if (!parser->init_gst(parser))
         goto out;
 
-- 
2.44.0

