From c5b60220062f7cd165a778867a75a1f664acb868 Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Wed, 31 Jan 2024 17:42:55 +0100
Subject: [PATCH 12/29] winegstreamer: Convert buffer presentation timestamps
 into running time.

---
 dlls/winegstreamer/wg_parser.c | 24 ++++++++++++++++++------
 1 file changed, 18 insertions(+), 6 deletions(-)

diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index aee34f965f5..9cabc0d899b 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -360,13 +360,25 @@ static NTSTATUS wg_parser_stream_get_buffer(void *args)
         return S_FALSE;
     }
 
-    /* FIXME: Should we use gst_segment_to_stream_time_full()? Under what
-     * circumstances is the stream time not equal to the buffer PTS? Note
-     * that this will need modification to wg_parser_stream_notify_qos() as
-     * well. */
-
     if ((wg_buffer->has_pts = GST_BUFFER_PTS_IS_VALID(buffer)))
-        wg_buffer->pts = GST_BUFFER_PTS(buffer) / 100;
+    {
+        if (stream->segment.format != GST_FORMAT_TIME)
+            wg_buffer->pts = GST_BUFFER_PTS(buffer) / 100;
+        else
+        {
+            guint64 stream_time = 0;
+            gint ret = gst_segment_to_running_time_full(&stream->segment, GST_FORMAT_TIME, GST_BUFFER_PTS(buffer), &stream_time);
+            if (!ret)
+            {
+                pthread_mutex_unlock(&parser->mutex);
+                return S_FALSE;
+            }
+            if (ret < 0)
+                wg_buffer->pts = -(gint64)stream_time / 100;
+            else
+                wg_buffer->pts = stream_time / 100;
+        }
+    }
     if ((wg_buffer->has_duration = GST_BUFFER_DURATION_IS_VALID(buffer)))
         wg_buffer->duration = GST_BUFFER_DURATION(buffer) / 100;
     wg_buffer->discontinuity = GST_BUFFER_FLAG_IS_SET(buffer, GST_BUFFER_FLAG_DISCONT);
-- 
2.44.0

