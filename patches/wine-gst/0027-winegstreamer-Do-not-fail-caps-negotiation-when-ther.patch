From 8a3c021891ac5fb79b9b092163661517d8d5e37e Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Tue, 19 Mar 2024 10:09:59 +0100
Subject: [PATCH 27/29] winegstreamer: Do not fail caps negotiation when
 there's a concurrent reconfigure.

If wg_parser_stream_enable is called between the time our sink's GST_QUERY_CAPS returns and the time our sink gets the
GST_QUERY_ACCEPT_CAPS query to finalize caps negotiation, GST_QUERY_ACCEPT_CAPS would likely return FALSE because the
caps that are being negotiated would not meet the requirements of the new stream->current_format set by
wg_parser_stream_enable.

Instead, accept both the old and the new format as valid caps in GST_QUERY_ACCEPT_CAPS, but discard buffers until the
correct caps have been negotiated (signalled by a GST_EVENT_CAPS).

Also try to omit the reconfigure event in some cases.
---
 dlls/winegstreamer/wg_parser.c | 45 +++++++++++++++++++++++++++++-----
 1 file changed, 39 insertions(+), 6 deletions(-)

diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index f5722486fb3..4c4ee4bcc2a 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -123,7 +123,7 @@ struct wg_parser_stream
     GstPad *my_sink;
     GstElement *flip, *decodebin;
     GstSegment segment;
-    struct wg_format preferred_format, current_format, codec_format;
+    struct wg_format preferred_format, current_format, next_format, codec_format;
 
     GstBuffer *buffer;
     GstMapInfo map_info;
@@ -264,10 +264,20 @@ static NTSTATUS wg_parser_stream_enable(void *args)
     struct wg_parser_stream *stream = get_stream(params->stream);
     const struct wg_format *format = params->format;
     struct wg_parser *parser = stream->parser;
+    BOOL need_reconf = FALSE;
 
     pthread_mutex_lock(&parser->mutex);
 
-    stream->current_format = *format;
+    while (stream->next_format.major_type != WG_MAJOR_TYPE_UNKNOWN)
+        pthread_cond_wait(&parser->stream_event_cond, &parser->mutex);
+
+    if (!wg_format_compare(&stream->current_format, format) && !(stream->has_caps && wg_format_compare(&stream->preferred_format, format)))
+    {
+        stream->next_format = *format;
+        need_reconf = TRUE;
+    }
+    else
+        stream->current_format = *format;
     stream->enabled = true;
 
     pthread_mutex_unlock(&parser->mutex);
@@ -277,9 +287,11 @@ static NTSTATUS wg_parser_stream_enable(void *args)
         bool flip = (params->flags & STREAM_ENABLE_FLAG_FLIP_RGB) && (format->u.video.height < 0);
 
         gst_util_set_object_arg(G_OBJECT(stream->flip), "method", flip ? "vertical-flip" : "none");
+        need_reconf = TRUE;
     }
 
-    push_event(stream->my_sink, gst_event_new_reconfigure());
+    if (need_reconf)
+        push_event(stream->my_sink, gst_event_new_reconfigure());
     return S_OK;
 }
 
@@ -291,6 +303,7 @@ static NTSTATUS wg_parser_stream_disable(void *args)
     pthread_mutex_lock(&parser->mutex);
     stream->enabled = false;
     stream->current_format.major_type = WG_MAJOR_TYPE_UNKNOWN;
+    stream->next_format.major_type = WG_MAJOR_TYPE_UNKNOWN;
     pthread_mutex_unlock(&parser->mutex);
     pthread_cond_broadcast(&parser->stream_event_cond);
     return S_OK;
@@ -802,6 +815,13 @@ static gboolean sink_event_cb(GstPad *pad, GstObject *parent, GstEvent *event)
             pthread_mutex_lock(&parser->mutex);
             wg_format_from_caps(&stream->preferred_format, caps);
             stream->has_caps = true;
+            if (stream->next_format.major_type != WG_MAJOR_TYPE_UNKNOWN
+                && wg_format_compare(&stream->preferred_format, &stream->next_format))
+            {
+                stream->current_format = stream->next_format;
+                stream->next_format.major_type = WG_MAJOR_TYPE_UNKNOWN;
+                pthread_cond_broadcast(&parser->stream_event_cond);
+            }
             pthread_mutex_unlock(&parser->mutex);
             pthread_cond_signal(&parser->init_cond);
             break;
@@ -864,6 +884,14 @@ static GstFlowReturn sink_chain_cb(GstPad *pad, GstObject *parent, GstBuffer *bu
 
     pthread_mutex_lock(&parser->mutex);
 
+    if (stream->next_format.major_type != WG_MAJOR_TYPE_UNKNOWN)
+    {
+        GST_DEBUG("Stream is changing format; discarding buffer.");
+        pthread_mutex_unlock(&parser->mutex);
+        gst_buffer_unref(buffer);
+        return GST_FLOW_OK;
+    }
+
     if (!stream->has_buffer)
     {
         stream->has_buffer = true;
@@ -1006,7 +1034,9 @@ static gboolean sink_query_cb(GstPad *pad, GstObject *parent, GstQuery *query)
             gst_query_parse_caps(query, &filter);
 
             pthread_mutex_lock(&parser->mutex);
-            if (stream->current_format.major_type != WG_MAJOR_TYPE_UNKNOWN)
+            if (stream->next_format.major_type != WG_MAJOR_TYPE_UNKNOWN)
+                caps = wg_format_to_caps(&stream->next_format);
+            else if (stream->current_format.major_type != WG_MAJOR_TYPE_UNKNOWN)
                 caps = wg_format_to_caps(&stream->current_format);
             else
                 caps = get_supported_formats();
@@ -1042,7 +1072,8 @@ static gboolean sink_query_cb(GstPad *pad, GstObject *parent, GstQuery *query)
 
             pthread_mutex_lock(&parser->mutex);
 
-            if (stream->current_format.major_type == WG_MAJOR_TYPE_UNKNOWN)
+            if (stream->current_format.major_type == WG_MAJOR_TYPE_UNKNOWN &&
+                stream->next_format.major_type == WG_MAJOR_TYPE_UNKNOWN)
             {
                 pthread_mutex_unlock(&parser->mutex);
                 gst_query_set_accept_caps_result(query, TRUE);
@@ -1051,7 +1082,8 @@ static gboolean sink_query_cb(GstPad *pad, GstObject *parent, GstQuery *query)
 
             gst_query_parse_accept_caps(query, &caps);
             wg_format_from_caps(&format, caps);
-            ret = wg_format_compare(&format, &stream->current_format);
+            ret = wg_format_compare(&format, &stream->current_format) ||
+                  wg_format_compare(&format, &stream->next_format);
 
             pthread_mutex_unlock(&parser->mutex);
 
@@ -1086,6 +1118,7 @@ static struct wg_parser_stream *create_stream(struct wg_parser *parser, char *id
     stream->number = parser->stream_count;
     stream->no_more_pads = true;
     stream->current_format.major_type = WG_MAJOR_TYPE_UNKNOWN;
+    stream->next_format.major_type = WG_MAJOR_TYPE_UNKNOWN;
 
     sprintf(pad_name, "qz_sink_%u", parser->stream_count);
     stream->my_sink = gst_pad_new(pad_name, GST_PAD_SINK);
-- 
2.44.0

