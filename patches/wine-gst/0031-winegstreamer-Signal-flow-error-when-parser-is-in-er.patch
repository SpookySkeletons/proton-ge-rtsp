From 4203e306cbf7365510a1b9cd45311dd4a5d872e7 Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Mon, 25 Mar 2024 22:49:12 +0100
Subject: [PATCH 31/39] winegstreamer: Signal flow error when parser is in
 error state.

TODO: is this needed?
---
 dlls/winegstreamer/wg_parser.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index 39041f1bb29..c9c3ccf12da 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -916,9 +916,17 @@ static GstFlowReturn sink_chain_cb(GstPad *pad, GstObject *parent, GstBuffer *bu
     /* Allow this buffer to be flushed by GStreamer. We are effectively
      * implementing a queue object here. */
 
-    while (stream->enabled && !stream->flushing && !has_buffer_capacity(stream, buffer))
+    while (stream->enabled && !stream->flushing && !stream->parser->error && !has_buffer_capacity(stream, buffer))
         pthread_cond_wait(&parser->stream_event_cond, &parser->mutex);
 
+    if (stream->parser->error)
+    {
+        GST_DEBUG("Parser is in error state; discarding buffer.");
+        pthread_mutex_unlock(&parser->mutex);
+        gst_buffer_unref(buffer);
+        return GST_FLOW_ERROR;
+    }
+
     if (!stream->enabled)
     {
         GST_DEBUG("Stream is disabled; discarding buffer.");
-- 
2.44.0

